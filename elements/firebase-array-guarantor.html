<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<dom-module id="firebase-array-guarantor">
  <template>
    <firebase-document path="{{path}}" data="{{fbData}}"></firebase-document>
  </template>

  <script>
    Polymer({
      is: 'firebase-array-guarantor',

      properties: {
        path: String,

        data: {
          notify: true,
          value: () => []
        },

        _integrityChecks: {
          value: () => []
        }
      },

      observers: [
        '_dataChanged(data.splices)',
        '_fbDataChanged(fbData.splices)'
      ],

      addIntegrityCheck: function(f) {
        this._integrityChecks.push(f);
      },

      _runIntegrityChecks: function(data) {
        if (this._integrityChecks)
          return this._integrityChecks.map(f => f(this.data)).every(r => r)
      },

      _dataChanged: function() {
        if (this._ping) {
          this._ping = false;
          return;
        }
        this._ping = true;

        if (this._runIntegrityChecks())
          this.fbData = [...this.data];
        else if (this.fbData)
          this.data = [...this.fbData];
      },

      _fbDataChanged: function() {
        if (this._ping) {
          this._ping = false;
          return;
        }
        this._ping = true;

        if (this.fbData.constructor === Object)
          this.data = [];
        else
          this.data = [...this.fbData];
      }
    });
  </script>
</dom-module>
