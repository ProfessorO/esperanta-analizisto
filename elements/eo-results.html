<link rel="import" href="../bower_components/paper-styles/shadow.html">

<dom-module id="eo-results">
  <template>

    <style>
      :host {
        display: block;
      }

      h2 {
        margin-bottom: var(--heading-margin);
      }

      #show {
        padding: 8px 0;
      }

      .popup {
        @apply(--shadow-elevation-4dp);

        position: absolute;
        background-color: white;
        padding: 1em;
      }

      .popup-label {
        font-weight: bold;
      }

      .popup-parsing {
        font-family: 'Roboto Mono';
      }

      .popup p:first-child {
        margin-top: 0;
      }
      .popup p:last-child {
        margin-bottom: 0;
      }
    </style>

    <h2>Results</h2>
    <div id="show"></div>

  </template>

  <script>
    Polymer({
      is: 'eo-results',

      properties: {
        results: {
          observer: '_show'
        },

        _colorArray: {
          value: [
            'hsl(205, 95%, 75%)',
            'hsl(0, 95%, 75%)',
            'hsl(90, 95%, 40%)',
            'hsl(280, 95%, 75%)',
            'hsl(35, 95%, 75%)'
          ]
        },

        _currentColorIndex: {
          value: -1
        }
      },

      _show: function() {
        let show = this.$.show;
        while (show.lastChild)
          show.removeChild(show.lastChild);

        for (let token of this.results) {
          if (!token.roots.length)
            this.$.show.appendChild(this._newSpan(token.token));
          else
            this._showWord(token);
        }

        this._resetColor();
      },

      _showWord: function(word) {
        let wordSpan = document.createElement('span');

        word.roots.forEach(root => wordSpan.appendChild(this._newSpan(root, true)));
        if (word.token != word.roots.join('')) {
          wordSpan.appendChild(
            this._newSpan(word.token.substr(word.roots.join('').length))
          );
        }
        wordSpan.word = word;

        wordSpan.events = [];
        wordSpan.onmouseover = wordSpan.onmouseout = this._mouseFunction(wordSpan);

        this.$.show.appendChild(wordSpan);
      },

      _newSpan: function(token, isRoot = false) {
        let span = document.createElement('span');

        if (isRoot) {
          span.classList.add('root');
          span.style.backgroundColor = this._nextColor();
        }

        span.textContent = token;

        return span;
      },

      _nextColor: function() {
        if (this._currentColorIndex < this._colorArray.length - 1)
          this._currentColorIndex++;
        else
          this._currentColorIndex = 0;
        return this._colorArray[this._currentColorIndex];
      },

      _resetColor: function() {
        this._currentColorIndex = -1;
      },

      _mouseFunction: function(wordSpan) {
        return event => {
          wordSpan.events.push(event);

          this.debounce('mouse', () => {
            let lastEvents = wordSpan.events.slice(-2);
            let first, second;

            if (lastEvents.length >= 2)
              [first, second] = [lastEvents[0], lastEvents[1]];
            else
              second = lastEvents[0];

            if (!first || first.timeStamp != second.timeStamp)
              this._popup(event.type, wordSpan);
          }, 1);
        };
      },

      _popup: function(type, wordSpan) {
        this.debounce('popup', () => {
          if (this.$$('.popup'))
            Polymer.dom(this.root).removeChild(this.$$('.popup'));

          if (type == 'mouseover') {
            let popup = document.createElement('div');
            popup.onmouseover = popup.onmouseout = this._mouseFunction(wordSpan);
            popup.classList.add('popup');

            popup.style.visibility = 'hidden';
            Polymer.dom(this.root).appendChild(popup);
            this.scopeSubtree(popup, true);

            popup.innerHTML = `
              <p>
                <span class="popup-label">Parsing</span>:
                <span class="popup-parsing">${wordSpan.word.roots.join('-')}</span>
              </p>
            `;

            this.async(() => this._positionPopup(popup, wordSpan), 1);
          }
        }, 200);
      },

      _positionPopup: function(popup, wordSpan, secondTime) {
        let wordRect = wordSpan.getBoundingClientRect();

        popup.style.top = (wordRect.top + document.body.scrollTop - popup.offsetHeight) + 'px';

        popup.style.left = '0';
        let left = wordRect.left + wordSpan.offsetWidth / 2 - popup.offsetWidth / 2;
        let docWidth = document.documentElement.clientWidth;
        left = left + popup.offsetWidth > docWidth - 4 ? docWidth - 4 - popup.offsetWidth : left;
        popup.style.left = (left < 4 ? 4 : left) + 'px';

        popup.style.visibility = '';

        if (!secondTime) {
          this.async(() => this._positionPopup(popup, wordSpan, true), 200);
          this.async(() => this._positionPopup(popup, wordSpan, true), 201);
        }
      }
    });
  </script>
</dom-module>
